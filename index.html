<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <title>CloudNotes</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <meta name="theme-color" content="#F5F5F7">
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        :root {
            --ios-bg: #F5F5F7;
            --ios-glass: rgba(255, 255, 255, 0.85);
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Inter", sans-serif;
            background-color: var(--ios-bg);
            color: #1d1d1f;
            -webkit-tap-highlight-color: transparent;
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
            /* ä½¿ç”¨ dvh è§£å†³ç§»åŠ¨ç«¯åœ°å€æ é®æŒ¡é—®é¢˜ */
            min-height: 100dvh;
            padding-top: max(20px, var(--safe-top)); 
        }

        /* åŠ¨æ€èƒŒæ™¯ */
        .ambient-light {
            position: fixed;
            top: -20%; left: -10%; width: 120vw; height: 120vw;
            background: radial-gradient(circle, rgba(0,122,255,0.12) 0%, rgba(0,0,0,0) 70%);
            filter: blur(60px); z-index: -1;
            animation: float 10s ease-in-out infinite alternate;
        }
        @keyframes float { 0% { transform: translate(0, 0);
            } 100% { transform: translate(30px, 30px); } }

        /* Apple é£æ ¼ç»„ä»¶ */
        .glass-panel {
            background: var(--ios-glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.6);
            box-shadow: 0 8px 32px rgba(0,0,0,0.04);
        }

        /* æŒ‰é’®è§¦æ„Ÿä¼˜åŒ– */
        .btn-ios {
            transition: transform 0.1s cubic-bezier(0.2, 0, 0, 1), opacity 0.2s, background-color 0.2s;
            touch-action: manipulation; /* é˜²æ­¢åŒå‡»ç¼©æ”¾å»¶è¿Ÿ */
        }
        .btn-ios:active {
            transform: scale(0.96);
            opacity: 0.9;
        }

        /* è¾“å…¥æ¡†ä¼˜åŒ– */
        .input-ios {
            font-size: 16px;
            /* é˜²æ­¢ iOS è‡ªåŠ¨æ”¾å¤§ */
            transition: all 0.3s ease;
            appearance: none;
        }
        .input-ios:focus {
            background: #fff;
            box-shadow: 0 0 0 4px rgba(0,122,255,0.15);
        }

        .safe-pb {
            padding-bottom: calc(2rem + var(--safe-bottom));
        }

        /* åº•éƒ¨æŠ½å±‰åŠ¨ç”» */
        @keyframes slideUp {
            from { transform: translateY(100%);
            }
            to { transform: translateY(0);
            }
        }
        .drawer-enter {
            animation: slideUp 0.35s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        /* æ–‡æœ¬æŠ˜å æ ·å¼ */
        .line-clamp-custom {
            display: -webkit-box;
            -webkit-line-clamp: 4; 
            -webkit-box-orient: vertical;
            overflow: hidden;
            mask-image: linear-gradient(180deg, #000 60%, transparent); 
            -webkit-mask-image: linear-gradient(180deg, #000 60%, transparent);
        }

        ::-webkit-scrollbar { width: 0px; background: transparent;
        }

        /* å›åˆ°é¡¶éƒ¨æŒ‰é’®æ ·å¼ */
        .back-to-top {
            position: fixed;
            bottom: calc(20px + var(--safe-bottom));
            right: 20px;
            width: 44px;
            height: 44px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(0,0,0,0.05);
            border-radius: 50%;
            box-shadow: 0 4px 15px rgba(0,0,0,0.12);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 40;
            color: #007AFF;
            opacity: 0;
            transform: translateY(20px) scale(0.9);
            pointer-events: none;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .back-to-top.visible {
            opacity: 1;
            transform: translateY(0) scale(1);
            pointer-events: auto;
        }
        .back-to-top:active {
            transform: scale(0.9);
            background: #f0f0f0;
        }
    </style>
</head>

<body class="selection:bg-blue-500/20 selection:text-blue-700 flex flex-col">
    
    <div class="ambient-light"></div>

    <div id="app" class="flex-1 w-full max-w-3xl mx-auto px-5 py-4 safe-pb relative z-10">
        </div>

    <button id="backToTop" onclick="scrollToTop()" class="back-to-top" aria-label="å›åˆ°é¡¶éƒ¨">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 19V5M5 12l7-7 7 7"/>
        </svg>
    </button>

    <div id="settingsModal" class="fixed inset-0 bg-black/30 backdrop-blur-md z-50 hidden flex items-end md:items-center justify-center transition-opacity duration-300" style="z-index: 9999;">
        <div class="absolute inset-0" onclick="closeSettings()"></div>
        
        <div class="drawer-enter bg-[#F9F9F9]/95 backdrop-blur-xl w-full md:w-[400px] md:rounded-[2rem] rounded-t-[2rem] shadow-2xl p-6 space-y-6 relative z-10 border-t border-white/50 
        md:border-none pb-[max(25px,env(safe-area-inset-bottom))]">
            <div class="w-10 h-1.5 bg-slate-300 rounded-full mx-auto md:hidden mb-2"></div>
            
            <div class="text-center space-y-1">
                <h2 class="text-lg font-bold text-slate-900">ç³»ç»Ÿè®¾ç½®</h2>
                <p class="text-xs text-slate-500">è¿æ¥æ‚¨çš„ Worker åç«¯</p>
            </div>

            <div class="space-y-4">
                <div class="space-y-1.5">
                    <label class="text-[11px] uppercase tracking-wider text-slate-400 font-bold ml-1">API Endpoint</label>
                    <input id="setApi" type="url" placeholder="https://..." inputmode="url"
                        class="w-full bg-white border border-slate-200 p-4 rounded-xl outline-none input-ios text-slate-700 font-medium placeholder:text-slate-400">
                    <p class="text-[10px] text-slate-400 ml-1">è¯·è¾“å…¥å®Œæ•´çš„ Worker åœ°å€ï¼ˆåŒ…å« https://ï¼‰</p>
                </div>
                <div class="space-y-1.5">
                    <label class="text-[11px] uppercase tracking-wider text-slate-400 font-bold ml-1">Admin Key</label>
                    <input id="setKey" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="new-password"
                        class="w-full bg-white border border-slate-200 p-4 rounded-xl outline-none input-ios text-slate-700 font-medium">
                </div>
            </div>
            <div class="grid grid-cols-2 gap-3 pt-2">
                <button onclick="closeSettings()" class="py-3.5 bg-slate-200/80 text-slate-600 font-bold rounded-xl btn-ios text-sm active:bg-slate-300">å–æ¶ˆ</button>
                <button onclick="saveSettings()" class="py-3.5 bg-[#007AFF] text-white font-bold rounded-xl shadow-lg shadow-blue-500/20 btn-ios text-sm active:bg-blue-600">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script>
        // --- å·¥å…·å‡½æ•°ï¼šHTML è½¬ä¹‰ï¼ˆé˜²æ­¢ XSSï¼‰ ---
        function escapeHtml(text) {
            if (text == null) return "";
            return String(text)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // --- æ ¸å¿ƒé…ç½® ---
        const urlParams = new URLSearchParams(window.location.search);
        const shareId = urlParams.get('share');
        
        let storedApi = "";
        let ADMIN_KEY = "";
        
        // [ä¿®å¤] Storage è®¿é—®æ·»åŠ  try-catch ä¿æŠ¤
        try {
            storedApi = localStorage.getItem('cf_notes_api') || "";
            ADMIN_KEY = localStorage.getItem('cf_notes_key') || "";
        } catch(e) { console.warn("Storage access restricted"); }

        // [å®‰å…¨] é—­åŒ…ç¼“å­˜ï¼Œé˜²æ­¢å…¨å±€æ±¡æŸ“
        let _PRIVATE_MEM_CACHE = [];
        if (storedApi.endsWith('/')) {
            storedApi = storedApi.slice(0, -1);
        }

        let API_URL = storedApi;
        const app = document.getElementById('app');

        // --- åŠ å¯†æ¨¡å— (PBKDF2 + AES-GCM) ---
        async function getK(pw, salt) {
            const enc = new TextEncoder();
            const keyMaterial = await crypto.subtle.importKey("raw", enc.encode(pw), { name: "PBKDF2" }, false, ["deriveKey"]);
            return await crypto.subtle.deriveKey({ name: "PBKDF2", salt: salt, iterations: 100000, hash: "SHA-256" }, keyMaterial, { name: "AES-GCM", length: 256 }, false, ["encrypt", "decrypt"]);
        }

        async function encrypt(text, pw) {
            const enc = new TextEncoder();
            const salt = crypto.getRandomValues(new Uint8Array(16));
            const iv = crypto.getRandomValues(new Uint8Array(12));
            const key = await getK(pw, salt);
            const cipher = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, key, enc.encode(text));
            return btoa(JSON.stringify({ iv: Array.from(iv), salt: Array.from(salt), data: Array.from(new Uint8Array(cipher)) }));
        }

        async function decrypt(json, pw) {
            try {
                const parsed = JSON.parse(atob(json));
                if (!parsed.salt) throw new Error("Legacy");
                const iv = new Uint8Array(parsed.iv);
                const salt = new Uint8Array(parsed.salt);
                const data = new Uint8Array(parsed.data);
                const key = await getK(pw, salt);
                const dec = await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, key, data);
                return new TextDecoder().decode(dec);
            } catch (e) { return null; }
        }

        // --- è§†å›¾é€»è¾‘ ---

        function init() {
            if (shareId) renderShareView();
            else renderMainView();
            
            // ç›‘å¬æ»šåŠ¨ä»¥æ˜¾ç¤ºå›åˆ°é¡¶éƒ¨æŒ‰é’®
            window.addEventListener('scroll', () => {
                const btn = document.getElementById('backToTop');
                if (window.scrollY > 300) {
                    btn.classList.add('visible');
                } else {
                    btn.classList.remove('visible');
                }
            });
        }

        // å›åˆ°é¡¶éƒ¨åŠŸèƒ½
        function scrollToTop() {
            if(navigator.vibrate) navigator.vibrate(5);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function renderMainView() {
            app.innerHTML = `
            <div class="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
                <header class="flex justify-between items-center pt-2 sticky top-0 z-20 mix-blend-hard-light">
                    <div>
                        <h1 class="text-2xl font-bold text-slate-900 tracking-tight">CloudNotes</h1>
                        <p class="text-[10px] uppercase tracking-wider text-slate-500 font-bold">Encrypted Vault</p>
                    </div>
                    <button onclick="configUrl()" class="w-10 h-10 rounded-full bg-white/80 backdrop-blur text-slate-500 shadow-sm border border-white flex items-center justify-center btn-ios 
                    active:bg-slate-100">
                        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 
                        2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                    </button>
                </header>

                <main class="glass-panel p-5 rounded-[1.8rem] space-y-4 shadow-sm">
                    <input id="mainPw" type="password" placeholder="è¾“å…¥ä¸»å¯†é’¥ (Passkey)" autocomplete="current-password"
                        class="w-full bg-white/60 border border-white p-4 rounded-xl outline-none input-ios text-slate-800 placeholder:text-slate-400 transition-colors focus:bg-white focus:ring-2 focus:ring-blue-500/10">
                    
                    <textarea id="noteInput" placeholder="åœ¨æ­¤è¾“å…¥éœ€è¦åŠ å¯†çš„å†…å®¹..." 
                        class="w-full bg-white/60 border border-white p-4 h-36 rounded-xl outline-none input-ios resize-none text-slate-800 leading-relaxed placeholder:text-slate-400 transition-colors focus:bg-white focus:ring-2 focus:ring-blue-500/10"></textarea>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="doSave()" class="bg-slate-900 text-white py-4 rounded-xl font-bold text-sm shadow-lg shadow-slate-900/10 btn-ios flex items-center justify-center gap-2 active:scale-95">
                            <span>ğŸ”’</span> åŠ å¯†å­˜å‚¨
                        </button>
                        <button onclick="doAI()" class="bg-white text-indigo-600 border border-indigo-100 py-4 rounded-xl font-bold text-sm btn-ios flex items-center justify-center gap-2 active:bg-indigo-50 active:scale-95">
                            <span>âœ¨</span> AI æ€»ç»“
                        </button>
                    </div>
                </main>

                <section class="space-y-4 pt-2">
                    <div class="flex justify-between items-center px-2">
                        <h2 class="text-xs font-bold uppercase tracking-widest text-slate-400">Notes Vault</h2>
                        <button onclick="loadList()" class="bg-blue-50 px-3 py-1.5 rounded-lg text-[#007AFF] text-xs font-bold btn-ios active:bg-blue-100 active:scale-95">åˆ·æ–° / æœç´¢</button>
                    </div>

                    <div id="searchBar" class="hidden px-1 animate-in slide-in-from-top-2 duration-300">
                        <div class="relative group">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-slate-400 pointer-events-none">
                                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                            </span>
                            <input id="searchInput" type="text" placeholder="æœç´¢å·²è§£å¯†çš„ç¬”è®°..." oninput="doSearch()" enterkeyhint="search"
                                class="w-full bg-slate-200/60 border-none rounded-xl py-2.5 pl-10 pr-10 text-sm text-slate-800 outline-none placeholder:text-slate-400 transition-all focus:bg-white focus:ring-2 focus:ring-blue-500/20 input-ios">
                            
                            <button id="clearSearchBtn" onclick="clearSearch()" class="absolute inset-y-0 right-0 flex items-center pr-3 text-slate-400 hidden">
                                <div class="w-4 h-4 bg-slate-300 rounded-full flex items-center justify-center text-white text-[10px]">âœ•</div>
                            </button>
                        </div>
                    </div>

                    <div id="notesList" class="grid gap-3 pb-8">
                        <div class="text-center py-12">
                            <div class="inline-block p-4 rounded-full bg-white/50 mb-2 text-2xl">â˜ï¸</div>
                            <p class="text-slate-400 text-sm">è¾“å…¥ä¸»å¯†é’¥ååˆ·æ–°<br>ä»…æ˜¾ç¤ºåŒ¹é…çš„åŠ å¯†ç¬”è®°</p>
                        </div>
                    </div>
                </section>
            </div>
        `;
        }

        function renderShareView() {
            app.innerHTML = `
            <div class="min-h-[80vh] flex flex-col justify-center px-2">
                <div class="glass-panel p-8 md:p-10 rounded-[2.5rem] shadow-2xl text-center space-y-6 animate-in zoom-in duration-500">
                    <div class="w-20 h-20 bg-orange-500 rounded-full mx-auto flex items-center justify-center text-4xl shadow-lg shadow-orange-500/30">ğŸ”¥</div>
                    <div>
                        <h1 class="text-2xl font-bold text-slate-900">é˜…åå³ç„š</h1>
                        <p class="text-slate-500 text-sm mt-1">æ•°æ®å°†åœ¨è§£å¯†åç«‹å³ç‰©ç†é”€æ¯</p>
                    </div>
        
                    <input id="sharePw" type="password" placeholder="è¾“å…¥è§£å¯†å¯†ç " inputmode="numeric"
                        class="w-full bg-white p-4 rounded-2xl outline-none text-center font-bold text-lg border border-slate-100 input-ios focus:ring-2 ring-orange-500/20">

                    <button id="unlockBtn" onclick="doUnlockShare()" class="w-full bg-gradient-to-r from-orange-500 to-red-500 text-white 
                    py-4 rounded-2xl font-bold shadow-lg shadow-orange-500/20 btn-ios text-lg active:scale-95">
                        ç«‹å³è§£å¯†
                    </button>
                    
                    <div id="shareResult" class="mt-6 text-left p-5 bg-slate-50 rounded-2xl hidden whitespace-pre-wrap 
                    text-sm leading-relaxed border border-slate-200 text-slate-700 font-mono break-words"></div>
                </div>
            </div>
        `;
        }

        /* --- äº¤äº’é€»è¾‘ --- */
        
        function configUrl() {
            const modal = document.getElementById('settingsModal');
            modal.classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('setApi').value = storedApi || "https://";
                document.getElementById('setKey').value = ADMIN_KEY;
            }, 10);
        }
        function closeSettings() { 
            document.getElementById('settingsModal').classList.add('hidden');
        }
        function saveSettings() {
            let newApi = document.getElementById('setApi').value.trim();
            if (newApi.endsWith('/')) newApi = newApi.slice(0, -1);
            
            try {
                localStorage.setItem('cf_notes_api', newApi);
                localStorage.setItem('cf_notes_key', document.getElementById('setKey').value);
            } catch(e) { alert("è®¾ç½®æ— æ³•ä¿å­˜ï¼ˆéšèº«æ¨¡å¼é™åˆ¶ï¼‰"); }
            
            location.reload();
        }

        async function doSave() {
            const text = document.getElementById('noteInput').value;
            const pw = document.getElementById('mainPw').value;
            if (!text || !pw) return alert("è¯·å¡«å†™å†…å®¹å’Œå¯†ç ");
            // ç®€å•éœ‡åŠ¨åé¦ˆ
            if(navigator.vibrate) navigator.vibrate(10);
            try {
                const cipher = await encrypt(text, pw);
                const res = await fetch(`${API_URL}/api/save`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': ADMIN_KEY },
                    body: JSON.stringify({ content: cipher })
                });
                if (res.ok) { 
                    alert("âœ… å·²åŠ å¯†å­˜å…¥");
                    document.getElementById('noteInput').value = ""; 
                    loadList(); 
                } else { alert("âŒ ä¿å­˜å¤±è´¥ï¼šè¯·æ£€æŸ¥ Key æˆ–ç½‘ç»œ");
                }
            } catch (e) { alert("âŒ ç½‘ç»œå¼‚å¸¸ï¼š" + e.message);
            }
        }

        async function loadList() {
            const pw = document.getElementById('mainPw').value;
            if (!pw) return alert("è¯·è¾“å…¥ä¸»å¯†é’¥ä»¥ç­›é€‰æ‚¨çš„ç¬”è®°");
            
            const listDiv = document.getElementById('notesList');
            const searchBar = document.getElementById('searchBar');
            // è§¦è§‰åé¦ˆ
            if(navigator.vibrate) navigator.vibrate(5);
            listDiv.innerHTML = '<div class="text-center py-8 text-slate-400 text-sm animate-pulse">æ­£åœ¨åŒæ­¥å¹¶è§£å¯†...</div>';
            
            try {
                const res = await fetch(`${API_URL}/api/list`, { headers: { 'Authorization': ADMIN_KEY } });
                const notes = await res.json(); 
                
                if (notes.error) throw new Error(notes.error);
                // [å®‰å…¨] æ¸…ç©ºå¹¶é‡å»ºå†…å­˜ç´¢å¼•ï¼Œä¸ä½¿ç”¨å…¨å±€å˜é‡
                _PRIVATE_MEM_CACHE = [];
                for (let n of notes) {
                    const clearText = await decrypt(n.content, pw);
                    if (clearText) {
                        _PRIVATE_MEM_CACHE.push({ ...n, clearText: clearText });
                    }
                }

                renderNotesToDom(_PRIVATE_MEM_CACHE);
                if (_PRIVATE_MEM_CACHE.length > 0) {
                    searchBar.classList.remove('hidden');
                } else {
                    searchBar.classList.add('hidden');
                }

            } catch (e) { 
                console.error(e);
                listDiv.innerHTML = '<div class="text-center py-8 text-red-400 text-sm">è¿æ¥å¤±è´¥ï¼š' + escapeHtml(e.message) + '</div>';
            }
        }

        function renderNotesToDom(notesArray) {
            const listDiv = document.getElementById('notesList');
            listDiv.innerHTML = "";
            
            if (notesArray.length === 0) {
                listDiv.innerHTML = `
                        <div class="text-center py-12 space-y-2">
                            <div class="text-3xl">ğŸ“­</div>
                            <p class="text-slate-500 text-sm font-bold">æ— åŒ¹é…æ•°æ®</p>
                        </div>`;
                return;
            }

            notesArray.forEach(n => {
                const card = document.createElement('div');
                card.className = "bg-white p-5 rounded-[1.2rem] shadow-sm border border-slate-100 flex flex-col gap-3 relative overflow-hidden animate-in fade-in zoom-in duration-300 group";
                
                // åˆ¤æ–­å†…å®¹æ˜¯å¦è¿‡é•¿ (è¶…è¿‡150å­— æˆ– è¶…è¿‡4è¡Œ)
                const isLong = n.clearText.length > 150 || (n.clearText.match(/\n/g) || []).length > 3;
                
                // [å®‰å…¨] ä½¿ç”¨ escapeHtml è½¬ä¹‰ ID å’Œæ—¶é—´
                const safeId = escapeHtml(n.id);
                const safeDate = escapeHtml(new Date(n.created_at).toLocaleDateString() + ' ' + new Date(n.created_at).toLocaleTimeString().slice(0,5));

                const headerHtml = `
                    <div class="flex justify-between items-center opacity-60">
                        <span class="text-[10px] font-bold bg-slate-100 px-2 py-0.5 rounded text-slate-500">#${safeId}</span>
                        <span class="text-[10px] font-medium text-slate-400">${safeDate}</span>
                    </div>
                `;
               
                // [å®‰å…¨] ä½¿ç”¨ textContent é˜²æ­¢ XSS
                const contentWrapper = document.createElement('div');
                const contentDiv = document.createElement('div');
                contentDiv.id = `content-${safeId}`;
                contentDiv.className = `text-sm leading-relaxed whitespace-pre-wrap break-words text-slate-700 ${isLong ? 'line-clamp-custom' : ''}`;
                contentDiv.textContent = n.clearText; 

                contentWrapper.appendChild(contentDiv);
                // å±•å¼€æŒ‰é’®
                if (isLong) {
                    const btnHtml = `<button onclick="toggleExpand(${safeId})" id="btn-${safeId}" class="mt-2 text-[11px] font-bold text-[#007AFF] hover:opacity-70 focus:outline-none flex items-center gap-1 active:opacity-50 transition-opacity">å±•å¼€å…¨éƒ¨ <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M6 9l6 6 6-6"/></svg></button>`;
                    contentWrapper.insertAdjacentHTML('beforeend', btnHtml);
                }

                // [å®‰å…¨ä¿®å¤] ä¼ é€’ ID è€Œä¸æ˜¯ å¯†æ–‡(content) åˆ° HTML å±æ€§ä¸­ï¼Œé˜²æ­¢ XSS å’Œ å±æ€§æˆªæ–­
                const footerHtml = `
                    <div class="pt-3 border-t border-slate-50 flex items-center justify-between gap-2 mt-auto">
                        <button onclick="doShareCopy(${safeId})" class="flex-1 py-2.5 bg-blue-50 text-blue-600 rounded-lg text-xs font-bold active:bg-blue-100 active:scale-95 btn-ios transition">
                            ğŸ“¤ åˆ†äº«
                        </button>
                        <button class="export-btn flex-1 py-2.5 bg-emerald-50 text-emerald-600 rounded-lg text-xs font-bold active:bg-emerald-100 active:scale-95 btn-ios transition">
                            ğŸ’¾ å¤‡ä»½
                        </button>
                        <button onclick="doDelete(${safeId})" class="flex-1 py-2.5 bg-red-50 text-red-500 rounded-lg text-xs font-bold active:bg-red-100 active:scale-95 btn-ios transition">
                            ğŸ—‘ï¸ åˆ é™¤
                        </button>
                    </div>
                `;
                card.innerHTML = headerHtml;
                card.appendChild(contentWrapper);
                card.insertAdjacentHTML('beforeend', footerHtml);
                
                card.querySelector('.export-btn').onclick = () => doExport(n.clearText, n.id);
                listDiv.appendChild(card);
            });
        }

        // æœ¬åœ°æœç´¢é€»è¾‘
        function doSearch() {
            const input = document.getElementById('searchInput');
            const clearBtn = document.getElementById('clearSearchBtn');
            const query = input.value.toLowerCase();
            
            // æ§åˆ¶æ¸…é™¤æŒ‰é’®æ˜¾ç¤º
            if (query.length > 0) clearBtn.classList.remove('hidden');
            else clearBtn.classList.add('hidden');

            const filtered = _PRIVATE_MEM_CACHE.filter(n => n.clearText.toLowerCase().includes(query));
            renderNotesToDom(filtered);
        }

        function clearSearch() {
            const input = document.getElementById('searchInput');
            input.value = "";
            input.focus();
            doSearch();
        }

        // æŠ˜å /å±•å¼€é€»è¾‘ [ä¼˜åŒ–ï¼šæ”¶èµ·æ—¶è‡ªåŠ¨å›æ»š]
        function toggleExpand(id) {
            const contentDiv = document.getElementById(`content-${id}`);
            const btn = document.getElementById(`btn-${id}`);
            
            if (contentDiv.classList.contains('line-clamp-custom')) {
                // å±•å¼€
                contentDiv.classList.remove('line-clamp-custom');
                contentDiv.style.maskImage = 'none';
                contentDiv.style.webkitMaskImage = 'none';
                btn.innerHTML = `æ”¶èµ· <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" style="transform: rotate(180deg)"><path d="M6 9l6 6 6-6"/></svg>`;
            } else {
                // æ”¶èµ·
                contentDiv.classList.add('line-clamp-custom');
                contentDiv.style.maskImage = '';
                contentDiv.style.webkitMaskImage = '';
                btn.innerHTML = `å±•å¼€å…¨éƒ¨ <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M6 9l6 6 6-6"/></svg>`;
                
                // [ä¼˜åŒ–] æ”¶èµ·æ—¶å¹³æ»‘æ»šåŠ¨å›å¡ç‰‡é¡¶éƒ¨ï¼Œé˜²æ­¢é•¿æ–‡æ”¶èµ·åè§†çº¿ä¸¢å¤±
                const card = btn.closest('.bg-white');
                if (card) {
                    const offset = card.getBoundingClientRect().top + window.pageYOffset - 100;
                    window.scrollTo({ top: offset, behavior: 'smooth' });
                }
            }
        }

        // [å®‰å…¨ä¿®å¤] ç°åœ¨é€šè¿‡ ID æŸ¥æ‰¾å†…å®¹ï¼Œè€Œä¸æ˜¯ä» HTML å±æ€§ä¸­è¯»å–å¯†æ–‡
        async function doShareCopy(id) {
            // åœ¨å†…å­˜ç¼“å­˜ä¸­æŸ¥æ‰¾å¯¹åº”çš„ç¬”è®°
            const note = _PRIVATE_MEM_CACHE.find(n => n.id == id);
            if (!note) return alert("ç¬”è®°æœªæ‰¾åˆ°");
            const cipher = note.content;

            const pid = Math.random().toString(36).substring(2, 12);
            if(navigator.vibrate) navigator.vibrate(10);
            try {
                const res = await fetch(`${API_URL}/api/save`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': ADMIN_KEY },
                    body: JSON.stringify({ content: cipher, public_id: pid, is_share: 1 })
                });
                if(!res.ok) throw new Error("API Error");
                
                const fullUrl = `${window.location.origin}${window.location.pathname}?share=${pid}`;
                if (navigator.share) {
                    navigator.share({ title: 'é˜…åå³ç„šé“¾æ¥', url: fullUrl }).catch(() => prompt("é“¾æ¥ï¼š", fullUrl));
                } else {
                    prompt("ğŸ”¥ é˜…åå³ç„šé“¾æ¥ï¼š", fullUrl);
                }
            } catch (e) { alert("ç”Ÿæˆå¤±è´¥");
            }
        }

        function doExport(text, id) {
            if(navigator.vibrate) navigator.vibrate(10);
            const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url;
            a.download = `Note_${id}.txt`; a.click();
        }

        async function doDelete(id) {
            if (!confirm("âš ï¸ ç¡®å®šæ°¸ä¹…åˆ é™¤ï¼Ÿ")) return;
            if(navigator.vibrate) navigator.vibrate([10, 30, 10]);
            await fetch(`${API_URL}/api/delete`, {
                method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': ADMIN_KEY },
                body: JSON.stringify({ id: id })
            });
            loadList();
        }

        async function doAI() {
            const text = document.getElementById('noteInput').value;
            if (!text) return alert("ç¬”è®°ä¸ºç©º");
            if(!confirm("âš ï¸ éšç§è­¦å‘Šï¼š\nAI æ€»ç»“éœ€å°†å‰ 1000 å­—ç¬¦ã€æ˜æ–‡ã€‘å‘é€è‡³æœåŠ¡å™¨ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ")) return;

            const btn = event.target; 
            const oldHtml = btn.innerHTML;
            btn.innerHTML = `<span class="animate-spin inline-block">â³</span>`; btn.disabled = true;
            
            try {
                const res = await fetch(`${API_URL}/api/ai-sum`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': ADMIN_KEY },
                    body: JSON.stringify({ text: text.substring(0, 1000) })
                });
                const data = await res.json();
                document.getElementById('noteInput').value += `\n\n--- AI æ‘˜è¦ ---\n${data.summary}`;
                if(navigator.vibrate) navigator.vibrate(20);
            } catch(e) { alert("AI æœåŠ¡å‡ºé”™æˆ–ç½‘ç»œä¸å¯è¾¾");
            } 
            finally { btn.innerHTML = oldHtml;
            btn.disabled = false; }
        }

        async function doUnlockShare() {
            const pw = document.getElementById('sharePw').value;
            const resDiv = document.getElementById('shareResult');
            const btn = document.getElementById('unlockBtn');
            try {
                // [å®‰å…¨ä¿®å¤] å¯¹ shareId è¿›è¡Œç¼–ç ï¼Œé˜²æ­¢ URL æ³¨å…¥
                const res = await fetch(`${API_URL}/api/share/${encodeURIComponent(shareId)}`);
                if (!res.ok) return alert("é“¾æ¥å·²å¤±æ•ˆæˆ–ç½‘ç»œé”™è¯¯");
                const data = await res.json(); 
                const clearText = await decrypt(data.content, pw);
                if (clearText) { 
                    resDiv.textContent = clearText;
                    resDiv.classList.remove('hidden'); 
                    btn.disabled = true; btn.className = "w-full bg-slate-200 text-slate-400 py-4 rounded-2xl font-bold"; btn.innerText = "æ•°æ®å·²é”€æ¯";
                } else alert("å¯†ç é”™è¯¯");
            } catch (e) { alert("ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥"); }
        }

        init();
    </script>
</body>
</html>
