<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CloudNotes</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#F5F5F7">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        :root { --ios-bg: #F5F5F7; --ios-glass: rgba(255, 255, 255, 0.85); --safe-top: env(safe-area-inset-top); --safe-bottom: env(safe-area-inset-bottom); }
        body { font-family: -apple-system, BlinkMacSystemFont, "Inter", sans-serif; background-color: var(--ios-bg); color: #1d1d1f; -webkit-tap-highlight-color: transparent; -webkit-font-smoothing: antialiased; overflow-x: hidden; min-height: 100dvh; padding-top: max(20px, var(--safe-top)); }
        .ambient-light { position: fixed; top: -20%; left: -10%; width: 120vw; height: 120vw; background: radial-gradient(circle, rgba(0,122,255,0.12) 0%, rgba(0,0,0,0) 70%); filter: blur(60px); z-index: -1; animation: float 10s ease-in-out infinite alternate; pointer-events: none; will-change: transform; }
        @keyframes float { 0% { transform: translate(0, 0); } 100% { transform: translate(30px, 30px); } }
        .glass-panel { background: var(--ios-glass); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.6); box-shadow: 0 8px 32px rgba(0,0,0,0.04); }
        .btn-ios { transition: transform 0.1s cubic-bezier(0.2, 0, 0, 1), opacity 0.2s, background-color 0.2s; touch-action: manipulation; user-select: none; -webkit-user-select: none; }
        @media (hover: hover) { .btn-ios:hover { opacity: 0.85; } }
        .btn-ios:active { transform: scale(0.96); opacity: 0.9; }
        .input-ios { font-size: 16px; transition: all 0.3s ease; appearance: none; }
        .input-ios:focus { background: #fff; box-shadow: 0 0 0 4px rgba(0,122,255,0.15); }
        .safe-pb { padding-bottom: calc(2rem + var(--safe-bottom)); }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .drawer-enter { animation: slideUp 0.35s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .line-clamp-custom { display: -webkit-box; -webkit-line-clamp: 5; -webkit-box-orient: vertical; overflow: hidden; mask-image: linear-gradient(180deg, #000 60%, transparent); -webkit-mask-image: linear-gradient(180deg, #000 60%, transparent); }
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        .back-to-top { position: fixed; bottom: calc(20px + var(--safe-bottom)); right: 20px; width: 44px; height: 44px; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(0,0,0,0.05); border-radius: 50%; box-shadow: 0 4px 15px rgba(0,0,0,0.12); display: flex; align-items: center; justify-content: center; z-index: 40; color: #007AFF; opacity: 0; transform: translateY(20px) scale(0.9); pointer-events: none; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); user-select: none; -webkit-user-select: none; }
        .back-to-top.visible { opacity: 1; transform: translateY(0) scale(1); pointer-events: auto; }
        .back-to-top:active { transform: scale(0.9); background: #f0f0f0; }
        .mode-section { transition: all 0.3s ease-in-out; }
        .hidden-mode { display: none !important; opacity: 0; }
        .load-more-btn { margin: 0 auto; display: inline-flex; align-items: center; justify-content: center; font-size: 13px; font-weight: 500; color: #64748b; background: rgba(255,255,255,0.5); padding: 10px 24px; border-radius: 99px; border: 1px solid rgba(0,0,0,0.05); }
    </style>
</head>

<body class="selection:bg-blue-500/20 selection:text-blue-700 flex flex-col">
    <div class="ambient-light"></div>
    <div id="app" class="flex-1 w-full max-w-4xl mx-auto px-4 md:px-6 py-4 safe-pb relative z-10 flex flex-col"></div>

    <button id="backToTop" onclick="scrollToTop()" class="back-to-top" aria-label="å›åˆ°é¡¶éƒ¨">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19V5M5 12l7-7 7 7"/></svg>
    </button>

    <div id="settingsModal" class="fixed inset-0 bg-black/30 backdrop-blur-md z-50 hidden flex items-end md:items-center justify-center transition-opacity duration-300" style="z-index: 9999;">
        <div class="absolute inset-0" onclick="closeSettings()"></div>
        <div class="drawer-enter bg-[#F9F9F9]/95 backdrop-blur-xl w-full md:w-[400px] md:rounded-[2rem] rounded-t-[2rem] shadow-2xl p-6 space-y-6 relative z-10 border-t border-white/50 md:border-none pb-[max(25px,env(safe-area-inset-bottom))]">
            <div class="w-10 h-1.5 bg-slate-300 rounded-full mx-auto md:hidden mb-2"></div>
            <div class="text-center space-y-1">
                <h2 class="text-lg font-bold text-slate-900">ç³»ç»Ÿè®¾ç½®</h2>
                <p class="text-xs text-slate-500">è¿æ¥ Worker åç«¯</p>
            </div>
            <div class="space-y-4">
                <div class="space-y-1.5">
                    <label class="text-[11px] uppercase tracking-wider text-slate-400 font-bold ml-1">API Endpoint</label>
                    <input id="setApi" type="url" placeholder="https://..." inputmode="url" class="w-full bg-white border border-slate-200 p-4 rounded-xl outline-none input-ios text-slate-700 font-medium placeholder:text-slate-400">
                    <p class="text-[10px] text-slate-400 ml-1">è¾“å…¥å®Œæ•´çš„ Worker åœ°å€</p>
                </div>
                <div class="space-y-1.5">
                    <label class="text-[11px] uppercase tracking-wider text-slate-400 font-bold ml-1">Admin Key</label>
                    <input id="setKey" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="new-password" class="w-full bg-white border border-slate-200 p-4 rounded-xl outline-none input-ios text-slate-700 font-medium">
                </div>
            </div>
            <div class="grid grid-cols-2 gap-3 pt-2">
                <button onclick="closeSettings()" class="py-3.5 bg-slate-200/80 text-slate-600 font-bold rounded-xl btn-ios text-sm active:bg-slate-300">å–æ¶ˆ</button>
                <button onclick="saveSettings()" class="py-3.5 bg-[#007AFF] text-white font-bold rounded-xl shadow-lg shadow-blue-500/20 btn-ios text-sm active:bg-blue-600">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script>
        // --- Utils ---
        const vibrate = (p) => navigator.vibrate && navigator.vibrate(p);
        function escapeHtml(t) { return t == null ? "" : String(t).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); }
        function yieldToMain() { return new Promise(r => setTimeout(r, 0)); }

        // --- Config ---
        const urlParams = new URLSearchParams(window.location.search);
        const shareId = urlParams.get('share');
        let storedApi = "", ADMIN_KEY = "";

        try {
            storedApi = localStorage.getItem('cf_notes_api') || "";
            ADMIN_KEY = (localStorage.getItem('cf_notes_key') || "").trim();
        } catch(e) { console.warn("Storage restricted"); }

        let _PRIVATE_MEM_CACHE = [];
        let _RENDERED_COUNT = 0;
        const _PAGE_SIZE = 24; 
        
        if (storedApi.endsWith('/')) storedApi = storedApi.slice(0, -1);
        let API_URL = storedApi;
        const app = document.getElementById('app');

        // --- Crypto ---
        async function getK(pw, salt) {
            const enc = new TextEncoder();
            const keyMaterial = await crypto.subtle.importKey("raw", enc.encode(pw), { name: "PBKDF2" }, false, ["deriveKey"]);
            return await crypto.subtle.deriveKey({ name: "PBKDF2", salt: salt, iterations: 600000, hash: "SHA-256" }, keyMaterial, { name: "AES-GCM", length: 256 }, false, ["encrypt", "decrypt"]);
        }

        async function encrypt(text, pw) {
            const enc = new TextEncoder();
            const salt = crypto.getRandomValues(new Uint8Array(16));
            const iv = crypto.getRandomValues(new Uint8Array(12));
            const key = await getK(pw, salt);
            const cipher = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, key, enc.encode(text));
            return btoa(JSON.stringify({ iv: Array.from(iv), salt: Array.from(salt), data: Array.from(new Uint8Array(cipher)) }));
        }

        async function decrypt(json, pw) {
            try {
                const parsed = JSON.parse(atob(json));
                if (!parsed.salt) throw new Error("Format Err");
                const iv = new Uint8Array(parsed.iv), salt = new Uint8Array(parsed.salt), data = new Uint8Array(parsed.data);
                const key = await getK(pw, salt);
                const dec = await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, key, data);
                return new TextDecoder().decode(dec);
            } catch (e) { return null; }
        }

        // --- Init ---
        function init() {
            shareId ? renderShareView() : renderMainView();
            let ticking = false;
            window.addEventListener('scroll', () => {
                if (!ticking) {
                    window.requestAnimationFrame(() => {
                        const btn = document.getElementById('backToTop');
                        if (window.scrollY > 300) btn.classList.add('visible');
                        else btn.classList.remove('visible');
                        ticking = false;
                    });
                    ticking = true;
                }
            }, { passive: true });
        }

        function scrollToTop() {
            vibrate(5);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // --- Views ---
        function renderMainView() {
            app.innerHTML = `
            <div class="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500 w-full">
                <header class="flex justify-between items-center pt-2 sticky top-0 z-20 mix-blend-hard-light w-full">
                    <div>
                        <h1 class="text-2xl font-bold text-slate-900 tracking-tight">CloudNotes</h1>
                        <p class="text-[10px] uppercase tracking-wider text-slate-500 font-bold">Encrypted Vault</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="toggleWriteMode()" class="w-10 h-10 rounded-full bg-white/80 backdrop-blur text-slate-500 shadow-sm border border-white flex items-center justify-center btn-ios active:bg-slate-100">
                           <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"></path></svg>
                        </button>
                        <button onclick="configUrl()" class="w-10 h-10 rounded-full bg-white/80 backdrop-blur text-slate-500 shadow-sm border border-white flex items-center justify-center btn-ios active:bg-slate-100">
                             <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                        </button>
                    </div>
                </header>

                <main class="glass-panel p-5 rounded-[1.8rem] space-y-4 shadow-sm w-full">
                    <input id="mainPw" type="password" placeholder="è¾“å…¥ä¸»å¯†é’¥ (Passkey)" autocomplete="current-password" class="w-full bg-white/60 border border-white p-4 rounded-xl outline-none input-ios text-slate-800 placeholder:text-slate-400 transition-colors focus:bg-white focus:ring-2 focus:ring-blue-500/10">
                    <div id="writeModeArea" class="hidden-mode space-y-4">
                         <textarea id="noteInput" placeholder="åœ¨æ­¤è¾“å…¥éœ€è¦åŠ å¯†çš„å†…å®¹..." class="w-full bg-white/60 border border-white p-4 h-36 rounded-xl outline-none input-ios resize-none text-slate-800 leading-relaxed placeholder:text-slate-400 transition-colors focus:bg-white focus:ring-2 focus:ring-blue-500/10"></textarea>
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="doSave()" class="bg-slate-900 text-white py-4 rounded-xl font-bold text-sm shadow-lg shadow-slate-900/10 btn-ios flex items-center justify-center gap-2 active:scale-95">
                                <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                                <span>åŠ å¯†å­˜å‚¨</span>
                            </button>
                            <button onclick="doAI()" class="bg-white text-indigo-600 border border-indigo-100 py-4 rounded-xl font-bold text-sm btn-ios flex items-center justify-center gap-2 active:bg-indigo-50 active:scale-95">
                                <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg>
                                <span>AI æ€»ç»“</span>
                            </button>
                        </div>
                    </div>

                    <div id="readModeArea" class="mode-section pt-2">
                        <button onclick="loadList()" id="decryptBtn" class="w-full bg-blue-500/10 text-blue-600 border border-blue-100 py-4 rounded-xl font-bold text-sm btn-ios flex items-center justify-center gap-2 active:bg-blue-100 active:scale-95">
                            <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 9.9-1"></path></svg>
                            <span>è§£å¯†æŸ¥çœ‹ç¬”è®°</span>
                        </button>
                    </div>
                </main>

                <section class="space-y-4 pt-2 w-full">
                    <div id="searchBar" class="hidden px-1 animate-in slide-in-from-top-2 duration-300 w-full">
                       <div class="relative group">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-slate-400 pointer-events-none">
                                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                            </span>
                            <input id="searchInput" type="text" placeholder="æœç´¢å·²è§£å¯†çš„ç¬”è®°..." oninput="doSearch()" enterkeyhint="search" class="w-full bg-white border border-slate-200 shadow-sm rounded-xl py-2.5 pl-10 pr-10 text-sm text-slate-800 outline-none placeholder:text-slate-400 transition-all focus:ring-2 focus:ring-blue-500/20 input-ios">
                            <button id="clearSearchBtn" onclick="clearSearch()" class="absolute inset-y-0 right-0 flex items-center pr-3 text-slate-400 hidden">
                                <div class="w-4 h-4 bg-slate-300 rounded-full flex items-center justify-center text-white text-[10px]">âœ•</div>
                            </button>
                        </div>
                    </div>

                    <div id="notesList" class="grid grid-cols-1 gap-4 pb-2 items-start transition-all duration-500 ease-in-out">
                        <div class="col-span-full text-center py-12">
                            <div class="inline-block p-4 mb-2 text-slate-300">
                                <svg width="48" height="48" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path d="M17.5 19c0-1.7-1.3-3-3-3h-5c-1.7 0-3 1.3-3 3"></path><path d="M17.5 19h-11"></path><path d="M6.5 16A6.5 6.5 0 0 1 11 5c2.7 0 5 1.6 6 4a4.5 4.5 0 0 1 .5 10"></path></svg>
                            </div>
                            <p class="text-slate-400 text-sm">è¾“å…¥ä¸»å¯†é’¥åç‚¹å‡»è§£å¯†<br>æŸ¥çœ‹æ‚¨çš„å®‰å…¨ç¬”è®°</p>
                        </div>
                    </div>
                    <div id="loadMoreContainer" class="py-4 flex justify-center w-full hidden"></div>
                </section>
            </div>`;
        }

        function renderShareView() {
            app.innerHTML = `
            <div class="min-h-[80vh] flex flex-col justify-center px-2 w-full max-w-lg mx-auto">
                <div class="glass-panel p-8 md:p-10 rounded-[2.5rem] shadow-2xl text-center space-y-6 animate-in zoom-in duration-500">
                    <div class="w-20 h-20 bg-rose-500 rounded-full mx-auto flex items-center justify-center text-white shadow-lg shadow-rose-500/30">
                        <svg width="40" height="40" fill="currentColor" viewBox="0 0 24 24"><path d="M12 23a9.4 9.4 0 0 1-5.6-1.8c-.5-.4-.6-1-.2-1.5.3-.4.8-.5 1.3-.2a7.4 7.4 0 0 0 10.4-1.4 1 1 0 0 1 1.6 1.2A9.4 9.4 0 0 1 12 23zm0-22c-1.1 0-3.3 1.2-4.2 3.8-1 2.8.2 4.4 1.2 5.7.8 1 1 1.7 1 2.5 0 1.1-.9 2-2 2s-2-.9-2-2c0-.3-.2-.5-.5-.5s-.5.2-.5.5c0 1.7 1.3 3 3 3s3-1.3 3-3c0-1.3-.5-2.2-1.4-3.3C8.9 8.6 8 7.6 8.5 6c.4-1.1 1.4-2 2.6-2.8.7.6 1.4 1.4 2 2.3a1 1 0 0 0 1.6-1.2C13.8 3 12.8 1.8 12 1z"></path><path d="M17.6 15.6c-.4 0-.7-.3-.8-.6-.3-1.4-1.3-2.5-2.7-3-.5-.2-.8-.7-.6-1.2.2-.5.7-.8 1.2-.6 2 .6 3.5 2.2 4 4.2.1.5-.2 1-.7 1.1z"></path></svg>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-slate-900">é˜…åå³ç„š</h1>
                        <p class="text-slate-500 text-sm mt-1">æ•°æ®å°†åœ¨è§£å¯†åç«‹å³ç‰©ç†é”€æ¯</p>
                    </div>
                    <input id="sharePw" type="password" placeholder="è¾“å…¥è§£å¯†å¯†ç " inputmode="numeric" class="w-full bg-white p-4 rounded-2xl outline-none text-center font-bold text-lg border border-slate-100 input-ios focus:ring-2 ring-rose-500/20">
                    <button id="unlockBtn" onclick="doUnlockShare()" class="w-full bg-gradient-to-r from-rose-500 to-red-600 text-white py-4 rounded-2xl font-bold shadow-lg shadow-rose-500/20 btn-ios text-lg active:scale-95">ç«‹å³è§£å¯†</button>
                    <div id="shareResult" class="mt-6 text-left p-5 bg-slate-50 rounded-2xl hidden whitespace-pre-wrap text-sm leading-relaxed border border-slate-200 text-slate-700 font-mono break-words"></div>
                </div>
            </div>`;
        }

        // --- Logic ---
        function toggleWriteMode() {
            const w = document.getElementById('writeModeArea'), r = document.getElementById('readModeArea');
            const hidden = w.classList.contains('hidden-mode');
            w.classList.toggle('hidden-mode', !hidden);
            r.classList.toggle('hidden-mode', hidden);
            vibrate(10);
        }
        
        function configUrl() {
            document.getElementById('settingsModal').classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('setApi').value = storedApi || "https://";
                document.getElementById('setKey').value = ADMIN_KEY;
            }, 10);
        }

        function closeSettings() { document.getElementById('settingsModal').classList.add('hidden'); }

        function saveSettings() {
            let api = document.getElementById('setApi').value.trim();
            if (api.endsWith('/')) api = api.slice(0, -1);
            try {
                localStorage.setItem('cf_notes_api', api);
                localStorage.setItem('cf_notes_key', document.getElementById('setKey').value.trim()); 
            } catch(e) { alert("è®¾ç½®ä¿å­˜å¤±è´¥ï¼šæœ¬åœ°å­˜å‚¨å—é™"); }
            location.reload();
        }

        async function doSave() {
            const text = document.getElementById('noteInput').value.trim();
            const pw = ADMIN_KEY || document.getElementById('mainPw').value.trim();
            if (!text || !pw) return alert("è¯·å¡«å†™å†…å®¹å’Œå¯†ç ");
            vibrate(10);
            try {
                const cipher = await encrypt(text, pw);
                const res = await fetch(`${API_URL}/api/save`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': ADMIN_KEY },
                    body: JSON.stringify({ content: cipher })
                });
                if (res.ok) { 
                    alert("âœ… å·²åŠ å¯†å­˜å…¥");
                    document.getElementById('noteInput').value = ""; 
                    toggleWriteMode(); 
                    loadList();
                } else { 
                    const err = await res.json().catch(() => ({}));
                    alert("âŒ ä¿å­˜å¤±è´¥ï¼š" + (err.error || "è¯·æ£€æŸ¥ç½‘ç»œæˆ– Key"));
                }
            } catch (e) { alert("âŒ ç½‘ç»œå¼‚å¸¸ï¼š" + e.message); }
        }

        async function loadList() {
            const pw = ADMIN_KEY || document.getElementById('mainPw').value.trim();
            if (!pw) return alert("è¯·è¾“å…¥ä¸»å¯†é’¥ä»¥æŸ¥çœ‹ç¬”è®°");
            
            const listDiv = document.getElementById('notesList'), btn = document.getElementById('decryptBtn');
            const loadMore = document.getElementById('loadMoreContainer');
            vibrate(5);
            
            const originalText = btn.innerHTML;
            btn.innerHTML = `<span class="animate-spin inline-block"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg></span> <span>å¤„ç†ä¸­...</span>`;
            btn.disabled = true;
            
            listDiv.className = "grid grid-cols-1 gap-4 pb-2 items-start";
            listDiv.innerHTML = '<div class="col-span-full text-center py-8 text-slate-400 text-sm animate-pulse">æ­£åœ¨åŒæ­¥æ•°æ®...</div>';
            loadMore.classList.add('hidden');

            try {
                const res = await fetch(`${API_URL}/api/list`, { headers: { 'Authorization': ADMIN_KEY } });
                const notes = await res.json(); 
                if (notes.error) throw new Error(notes.error);
                
                listDiv.innerHTML = '<div class="col-span-full text-center py-8 text-slate-400 text-sm animate-pulse">æ­£åœ¨è§£å¯†ä¿é™©ç®±...</div>';
                _PRIVATE_MEM_CACHE = [];
                _RENDERED_COUNT = 0;

                let count = 0;
                for (let n of notes) {
                    const clearText = await decrypt(n.content, pw);
                    if (clearText) _PRIVATE_MEM_CACHE.push({ ...n, clearText });
                    count++;
                    if (count % 10 === 0) await yieldToMain();
                }

                renderNotesToDom(_PRIVATE_MEM_CACHE.slice(0, _PAGE_SIZE));
                _RENDERED_COUNT = _PAGE_SIZE;
                document.getElementById('searchBar').classList.toggle('hidden', _PRIVATE_MEM_CACHE.length === 0);
            } catch (e) { 
                listDiv.innerHTML = '<div class="col-span-full text-center py-8 text-red-400 text-sm">è¿æ¥é”™è¯¯ï¼š' + escapeHtml(e.message) + '</div>';
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function renderNotesToDom(list, append = false) {
            const div = document.getElementById('notesList'), more = document.getElementById('loadMoreContainer');
            if (!append) div.innerHTML = "";
            more.innerHTML = "";

            if (list.length === 0 && !append) {
                div.innerHTML = `<div class="col-span-full text-center py-12 space-y-2"><div class="text-3xl opacity-30"><svg width="40" height="40" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" class="mx-auto"><rect x="4" y="4" width="16" height="16" rx="2" ry="2"></rect><line x1="9" y1="9" x2="15" y2="15"></line><line x1="15" y1="9" x2="9" y2="15"></line></svg></div><p class="text-slate-500 text-sm font-bold">æ— åŒ¹é…æ•°æ®</p></div>`;
                more.classList.add('hidden');
                return;
            }

            div.classList.remove('md:grid-cols-2');
            div.classList.add('grid-cols-1');

            const frag = document.createDocumentFragment();
            list.forEach(n => {
                const card = document.createElement('div');
                card.className = "bg-white p-5 rounded-[1.2rem] shadow-sm border border-slate-100 flex flex-col gap-3 relative overflow-hidden animate-in fade-in zoom-in duration-300 group h-full";
                
                const isLong = n.clearText.length > 150 || (n.clearText.match(/\n/g) || []).length > 3;
                const safeId = escapeHtml(n.id);
                const dt = new Date(n.created_at);
                const safeDate = escapeHtml(`${dt.toLocaleDateString()} ${dt.toLocaleTimeString().slice(0,5)}`);

                card.innerHTML = `
                    <div class="flex justify-between items-center opacity-60">
                        <span class="text-[10px] font-bold bg-slate-100 px-2 py-0.5 rounded text-slate-500">#${safeId}</span>
                        <span class="text-[10px] font-medium text-slate-400">${safeDate}</span>
                    </div>`;
                
                const wrap = document.createElement('div');
                wrap.className = "flex-1";
                if (isLong) wrap.insertAdjacentHTML('beforeend', `<button onclick="toggleExpand(${safeId})" id="btn-top-${safeId}" class="mb-2 text-[11px] font-bold text-[#007AFF] hover:opacity-70 focus:outline-none flex items-center gap-1 active:opacity-50 transition-opacity hidden w-full justify-start btn-ios">æ”¶èµ· <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" style="transform: rotate(180deg)"><path d="M6 9l6 6 6-6"/></svg></button>`);

                const content = document.createElement('div');
                content.id = `content-${safeId}`;
                content.className = `text-sm leading-relaxed whitespace-pre-wrap break-words text-slate-700 ${isLong ? 'line-clamp-custom' : ''}`;
                content.textContent = n.clearText; // Safe: textContent handles escaping
                wrap.appendChild(content);

                if (isLong) wrap.insertAdjacentHTML('beforeend', `<button onclick="toggleExpand(${safeId})" id="btn-${safeId}" class="mt-2 text-[11px] font-bold text-[#007AFF] hover:opacity-70 focus:outline-none flex items-center gap-1 active:opacity-50 transition-opacity btn-ios">å±•å¼€å…¨éƒ¨ <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M6 9l6 6 6-6"/></svg></button>`);

                card.appendChild(wrap);
                card.insertAdjacentHTML('beforeend', `
                    <div class="pt-3 border-t border-slate-50 flex items-center justify-between gap-2 mt-auto">
                        <button onclick="doShareCopy(${safeId})" class="flex-1 py-2.5 bg-rose-50 text-rose-600 rounded-lg text-xs font-bold active:bg-rose-100 active:scale-95 btn-ios transition flex items-center justify-center gap-1.5" title="é˜…åå³ç„š"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15.362 5.214A8.252 8.252 0 0 1 12 21 8.25 8.25 0 0 1 6.038 7.048 8.287 8.287 0 0 0 9 9.6a8.983 8.983 0 0 1 3.361-6.867 8.21 8.21 0 0 0 3 2.48z"></path></svg> é˜…åå³ç„š</button>
                        <button class="export-btn flex-1 py-2.5 bg-emerald-50 text-emerald-600 rounded-lg text-xs font-bold active:bg-emerald-100 active:scale-95 btn-ios transition flex items-center justify-center gap-1.5"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg> å¤‡ä»½</button>
                        <button onclick="doDelete(${safeId})" class="flex-1 py-2.5 bg-slate-100 text-slate-500 rounded-lg text-xs font-bold active:bg-slate-200 active:scale-95 btn-ios transition flex items-center justify-center gap-1.5"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg> åˆ é™¤</button>
                    </div>`);
                
                card.querySelector('.export-btn').onclick = () => doExport(n.clearText, n.id);
                frag.appendChild(card);
            });
            div.appendChild(frag);

            const searchMode = document.getElementById('searchInput').value.length > 0;
            const shown = append ? _RENDERED_COUNT : list.length;
            
            if (!searchMode && shown < _PRIVATE_MEM_CACHE.length) {
                const btn = document.createElement('button');
                btn.className = 'load-more-btn btn-ios hover:bg-slate-50 transition-colors';
                btn.innerText = 'åŠ è½½æ›´å¤š';
                btn.onclick = loadMoreNotes;
                more.appendChild(btn);
                more.classList.remove('hidden');
            } else {
                more.classList.add('hidden');
            }
        }

        function loadMoreNotes() {
            const next = _PRIVATE_MEM_CACHE.slice(_RENDERED_COUNT, _RENDERED_COUNT + _PAGE_SIZE);
            if (next.length > 0) {
                _RENDERED_COUNT += next.length;
                renderNotesToDom(next, true);
            }
        }

        function doSearch() {
            const q = document.getElementById('searchInput').value.toLowerCase();
            document.getElementById('clearSearchBtn').classList.toggle('hidden', q.length === 0);
            renderNotesToDom(_PRIVATE_MEM_CACHE.filter(n => n.clearText.toLowerCase().includes(q)));
        }

        function clearSearch() {
            const inp = document.getElementById('searchInput');
            inp.value = ""; inp.focus();
            _RENDERED_COUNT = 0;
            renderNotesToDom([], false);
            const p1 = _PRIVATE_MEM_CACHE.slice(0, _PAGE_SIZE);
            if (p1.length > 0) {
                _RENDERED_COUNT = p1.length;
                renderNotesToDom(p1, false);
            }
        }

        function toggleExpand(id) {
            const div = document.getElementById(`content-${id}`);
            const btn = document.getElementById(`btn-${id}`), btnTop = document.getElementById(`btn-top-${id}`);
            const isC = div.classList.contains('line-clamp-custom');
            
            div.classList.toggle('line-clamp-custom');
            div.style.maskImage = isC ? 'none' : '';
            div.style.webkitMaskImage = isC ? 'none' : '';
            
            btn.innerHTML = isC ? `æ”¶èµ· <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" style="transform: rotate(180deg)"><path d="M6 9l6 6 6-6"/></svg>` 
                                : `å±•å¼€å…¨éƒ¨ <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M6 9l6 6 6-6"/></svg>`;
            if (btnTop) btnTop.classList.toggle('hidden', !isC);

            if (!isC) {
                const card = btn.closest('.bg-white');
                if (card) window.scrollTo({ top: card.getBoundingClientRect().top + window.pageYOffset - 80, behavior: 'smooth' });
            }
        }

        async function doShareCopy(id) {
            const note = _PRIVATE_MEM_CACHE.find(n => n.id == id);
            if (!note) return alert("ç¬”è®°æœªæ‰¾åˆ°");
            
            const pid = Math.random().toString(36).substring(2, 12);
            vibrate(10);
            try {
                const res = await fetch(`${API_URL}/api/save`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': ADMIN_KEY },
                    body: JSON.stringify({ content: note.content, public_id: pid, is_share: 1 })
                });
                if(!res.ok) throw new Error("API Error");
                
                const url = `${window.location.origin}${window.location.pathname}?share=${pid}`;
                if (navigator.share) navigator.share({ title: 'é˜…åå³ç„š', url: url }).catch(() => prompt("é“¾æ¥ï¼š", url));
                else prompt("ğŸ”¥ é˜…åå³ç„šé“¾æ¥ï¼š", url);
            } catch (e) { alert("ç”Ÿæˆå¤±è´¥"); }
        }

        function doExport(text, id) {
            vibrate(10);
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([text], { type: 'text/plain;charset=utf-8' }));
            a.download = `Note_${id}.txt`; a.click();
        }

        async function doDelete(id) {
            if (!confirm("âš ï¸ ç¡®å®šæ°¸ä¹…åˆ é™¤ï¼Ÿ")) return;
            vibrate([10, 30, 10]);
            await fetch(`${API_URL}/api/delete`, {
                method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': ADMIN_KEY },
                body: JSON.stringify({ id: id })
            });
            loadList();
        }

        async function doAI() {
            const text = document.getElementById('noteInput').value.trim();
            // FIX: ä¼˜å…ˆè¯»å–æœ¬åœ°å­˜å‚¨Keyï¼Œå¦‚æœä¸ºç©ºåˆ™è¯»å–è¾“å…¥æ¡†Keyï¼ˆä¸doSaveé€»è¾‘ä¸€è‡´ï¼‰
            const pw = ADMIN_KEY || document.getElementById('mainPw').value.trim();
            
            if (!text) return alert("ç¬”è®°ä¸ºç©º");
            if (!pw) return alert("è¯·è¾“å…¥ä¸»å¯†é’¥ (Admin Key)");

            if(!confirm("âš ï¸ éšç§è­¦å‘Šï¼š\nå†…å®¹å°†ã€æ˜æ–‡ã€‘å‘é€è‡³æœåŠ¡å™¨è¿›è¡Œæ‘˜è¦ã€‚")) return;

            const btn = event.target.closest('button');
            const oldHtml = btn.innerHTML;
            btn.innerHTML = `<span class="animate-spin inline-block"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg></span>`;
            btn.disabled = true;
            
            try {
                const res = await fetch(`${API_URL}/api/ai-sum`, {
                    method: 'POST', 
                    // FIX: ä½¿ç”¨ pw å˜é‡é‰´æƒ
                    headers: { 'Content-Type': 'application/json', 'Authorization': pw },
                    body: JSON.stringify({ text: "è¯·ç”¨ä¸­æ–‡æ€»ç»“ï¼š\n" + text.substring(0, 1000) })
                });
                
                // FIX: å¢åŠ çŠ¶æ€æ£€æŸ¥
                if (!res.ok) throw new Error("è¯·æ±‚å¤±è´¥ " + res.status);

                const data = await res.json();
                
                // FIX: å¢åŠ å­—æ®µæ£€æŸ¥ï¼Œé˜²æ­¢ undefined
                if (data.summary) {
                    document.getElementById('noteInput').value += `\n\n--- AI æ‘˜è¦ ---\n${data.summary}`;
                    vibrate(20);
                } else {
                    throw new Error("è¿”å›æ•°æ®æ ¼å¼é”™è¯¯ (æ—  summary)");
                }
            } catch(e) { 
                alert("AI æœåŠ¡é”™è¯¯ï¼š" + e.message); 
            } finally { 
                btn.innerHTML = oldHtml; 
                btn.disabled = false; 
            }
        }

        async function doUnlockShare() {
            const pw = document.getElementById('sharePw').value.trim();
            const resDiv = document.getElementById('shareResult'), btn = document.getElementById('unlockBtn');
            try {
                const res = await fetch(`${API_URL}/api/share/${encodeURIComponent(shareId)}`);
                if (!res.ok) return alert("é“¾æ¥å·²å¤±æ•ˆ");
                const data = await res.json(); 
                const text = await decrypt(data.content, pw);
                if (text) { 
                    resDiv.textContent = text;
                    resDiv.classList.remove('hidden'); 
                    btn.disabled = true; btn.className = "w-full bg-slate-200 text-slate-400 py-4 rounded-2xl font-bold"; btn.innerText = "æ•°æ®å·²é”€æ¯";
                } else alert("å¯†ç é”™è¯¯");
            } catch (e) { alert("ç½‘ç»œé”™è¯¯"); }
        }

        init();
    </script>
</body>
</html>
